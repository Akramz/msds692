# Authenticating REST APIs

**Problem:** We can register with a website's developer API so that it allows us to pull from its data APIs, but what impersonating a specific user so that we can pull from a specific user's account, such as at Facebook or Instagram? We need a way for the program to access private data without acquiring and saving the credentials of all those users, as we do with our simple API IDs (Zillow, youtube, ...). Enter OAuth2.

## OAuth2

When it comes to a data collection program (the *client*), most REST APIs will require the program to authenticate using OAuth2.  A *resource owner*, such as a Facebook or twitter user, has data stored on a *resource server*. The **key idea** is that the Facebook user should not have to give their login credentials to a client program so that the client can login. Instead, the client program gets an access token from an *authorization server* (usually just another server at target company) with approval (e.g., logging in with a dialog box) from the resource owner (Facebook user). Given the access token, the client code can access resources from the resource server.

Here is what the authorization dialog looks like when my client program tries to access data from my LinkedIn account:
 
<img src=figures/linkedin-allow.png width=300>

I login and then LinkedIn notifies my client program that it has permission to pull data using my account for a short period of time. It gives this permission by passing me an *access token* (basically yet another ID).

The authentication sequence is a tricky thing to get right but the basic idea is as follows.

1. The client program developer goes to a target company's developer website, such as twitter, and asks for an application ID or some other ID that will allow them access to the API. You might also get a so-called secret key from the company. We have already done this for Zillow and Google's YouTube.
1. The client program contacts a URL at the authorization server at the target company to request access using the application ID and usually a secret key.
1. The authorization server at that URL accepts the client program credentials and sends an access token back to the  client program via a URL typically specified in the application settings on the target company's developer dashboard or as a `redirect_uri` parameter on the authentication request. As you will see in my examples, authentication requires that your client pretend to be a web server for one HTTP request, to collect to the access token generated by the target company server.
1. The client program can then make REST API calls using the access token, usually for a limited period of time.

 From the [OAuth 2 document](https://tools.ietf.org/html/rfc6749):
 
```
     +--------+                               +---------------+
     |        |--(A)- Authorization Request ->|   Resource    |
     |        |                               |     Owner     |
     |        |<-(B)-- Authorization Grant ---|               |
     |        |                               +---------------+
     |        |
     |        |                               +---------------+
     |        |--(C)-- Authorization Grant -->| Authorization |
     | Client |                               |     Server    |
     |        |<-(D)----- Access Token -------|               |
     |        |                               +---------------+
     |        |
     |        |                               +---------------+
     |        |--(E)----- Access Token ------>|    Resource   |
     |        |                               |     Server    |
     |        |<-(F)--- Protected Resource ---|               |
     +--------+                               +---------------+
```

Here is [Twitter's Application authentication diagram](https://dev.twitter.com/oauth/application-only)

<img src="https://g.twimg.com/dev/documentation/image/appauth_0.png" width=700>

## One-off HTTP server

In order to get authentication to work, the authenticating server is going to contact us by calling back to our Web server. This is kind of annoying because then it means we have to have a Web server running even for a program that is pulling data from the web not serving data to the web. 

It's part of the security protocol that they must call us back rather than just return an access token. This is what I do when someone calls me and claims to be from my bank. I ask for their phone number and then validated through their main phone exchange or looking for that person's work page at the bank. The point is, that I call them back. I never trust someone contacting me out of the blue.
 
```python
import BaseHTTPServer
import urlparse

class MyHandler(BaseHTTPServer.BaseHTTPRequestHandler):
    def do_GET(self):
        p = self.path.split('?')
        if len(p) > 1:
            params = urlparse.parse_qs(p[1], True, True)
            print params
        self.send_response(200)
        self.end_headers()
        return

url = 'http://localhost:8000?user=parrt&foo=bar'
server_address = ('localhost', 8000)
httpd = BaseHTTPServer.HTTPServer(server_address, MyHandler)
print url
# Block until we get a single request to url
httpd.handle_request() # handle just one request
```

**Exercise**: get this server running and click on the link printed out. The server should not respond buy printing parameters until you click on the link.  Next, replace the `print` with a statement to open the URL in a web browser. The program should now flow automatically without user interaction.